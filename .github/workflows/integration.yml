name: Integration Tests

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_table:
        description: 'Target table to test'
        required: false
        default: 'ods_daily_stock_price_akshare'
        type: choice
        options:
        - 'ods_daily_stock_price_akshare'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration_test:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - uses: actions/checkout@v4

    - name: Add local bin to PATH
      run: |
        mkdir -p "$HOME/.local/bin"
        echo "$HOME/.local/bin" >> "$GITHUB_PATH"

    - name: Start MinIO
      run: |
        docker run -d --name minio \
          -p 9000:9000 \
          -p 9001:9001 \
          -e MINIO_ROOT_USER=minioadmin \
          -e MINIO_ROOT_PASSWORD=minioadmin \
          quay.io/minio/minio:latest \
          server /data --console-address ":9001"

    - name: Wait for MinIO
      run: |
        for i in {1..30}; do
          if curl -fsS http://localhost:9000/minio/health/ready >/dev/null; then
            echo "MinIO is ready"
            exit 0
          fi
          sleep 2
        done
        docker logs minio
        exit 1
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    
    - name: Install dependencies
      run: |
        uv sync --group dev --frozen
    
    - name: Cache MinIO client (mc)
      uses: actions/cache@v4
      with:
        path: ~/.local/bin/mc
        key: mc-${{ runner.os }}-linux-amd64-v1

    - name: Set up MinIO client
      run: |
        if ! command -v mc >/dev/null 2>&1; then
          curl -sL https://dl.min.io/client/mc/release/linux-amd64/mc -o "$HOME/.local/bin/mc"
          chmod +x "$HOME/.local/bin/mc"
        fi
        mc alias set local http://localhost:9000 minioadmin minioadmin
    
    - name: Run integration tests
      run: |
        uv run pytest tests/integration/ -v --tb=short
      env:
        AWS_EC2_METADATA_DISABLED: "true"
        S3_ENDPOINT: http://localhost:9000
        S3_ACCESS_KEY: minioadmin
        S3_SECRET_KEY: minioadmin
        S3_BUCKET_NAME: stock-data
        TEST_DATE: '2024-01-15'

    - name: Stop MinIO
      if: always()
      run: |
        docker rm -f minio
